<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Flappy Bird Pro - League Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
<style>
    html,body{margin:0;padding:0;overflow:hidden;background:#4ec0ca;font-family: 'Quicksand', sans-serif; user-select: none; font-weight: 700;}
    canvas{display:block;position:absolute;top:0;left:0;z-index:1;}
    
    #nickMenu, #langMenu {
        position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
        background:rgba(0,0,0,0.9);color:#fff;z-index:200;text-align:center;backdrop-filter: blur(10px);
    }
    #langMenu { display: none; z-index: 210; background:rgba(0,0,0,0.95); }

    #nickInput {
        padding:15px; font-size:20px; border-radius:15px; border:3px solid #f1c40f; margin:20px; 
        width:250px; text-align:center; outline: none; font-family: 'Quicksand', sans-serif; font-weight: 700;
    }

    .lang-opt {
        display:flex; align-items:center; gap:15px; background:rgba(255,255,255,0.1); 
        padding:15px; margin:10px; border-radius:15px; cursor:pointer; width:300px; transition:0.2s;
        border: 2px solid transparent;
    }
    .lang-opt:hover { background:rgba(255,255,255,0.2); border-color: #f1c40f; transform: scale(1.02); }

    #menu, #settingsMenu, #shopMenu, #finalMenu, #redeemMenu {
        position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
        background:rgba(0,0,0,0.7);color:#fff;z-index:100;text-align:center;backdrop-filter: blur(8px);
    }
    #settingsMenu, #shopMenu, #finalMenu, #redeemMenu { display: none; z-index: 110; }

    #shopMenu {
        padding: 20px;
        box-sizing: border-box;
    }
    #shopContent { 
        width: 100%;
        max-width: 420px;
        max-height: 55vh;
        overflow-y: auto;
        display: flex; 
        flex-direction: column; 
        align-items: center;
        padding-right: 5px;
        margin-bottom: 15px;
    }
    #shopContent::-webkit-scrollbar { width: 6px; }
    #shopContent::-webkit-scrollbar-thumb { background: #f1c40f; border-radius: 10px; }

    .shop-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: rgba(255,255,255,0.1); 
        margin: 6px 0; 
        padding: 12px 18px; 
        border-radius: 15px; 
        width: 95%; 
        box-sizing: border-box;
    }

    #breakOverlay {
        position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center;
        background:black; color:white; z-index:2000; text-align:center;
    }
    @keyframes breakPop {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    .break-title { 
        font-size: 35px; color: #f1c40f; margin-bottom: 30px; 
        animation: breakPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #demoOverlay {
        position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center;
        background:black; color:white; z-index:1000; text-align:center; cursor: pointer;
        animation: fadeInOverlay 0.8s ease;
    }
    #demoOverlay.fadeOut { animation: fadeOutOverlay 0.5s forwards; }
    #demoOverlay p { font-family: 'Georgia', serif; font-style: italic; opacity: 1; margin: 10px; }

    #continueText {
        margin-top: 30px; font-size: 22px; font-weight: bold; opacity: 0;
        animation: rgbText 2s infinite linear, fadeInText 1s forwards 1s;
    }

    @keyframes rgbText {
        0% { color: #ff0000; } 33% { color: #00ff00; } 66% { color: #0000ff; } 100% { color: #ff0000; }
    }

    .btn {
        padding:8px 16px; font-size:16px; border:none; border-radius:12px; background:#f1c40f;
        color:#2c3e50; font-weight:700; cursor:pointer; transition: 0.2s;
        box-shadow: 0 4px 0 #d4ac0d; margin: 6px; min-width: 90px; font-family: 'Quicksand', sans-serif;
    }
    .btn:hover { background: #f39c12; transform: scale(1.05); }
    .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #d4ac0d; }
    
    @keyframes rgb-glow {
        0% { background: #ff0000; box-shadow: 0 5px 0 #800000; }
        33% { background: #00ff00; box-shadow: 0 5px 0 #008000; }
        66% { background: #0000ff; box-shadow: 0 5px 0 #000080; }
        100% { background: #ff0000; box-shadow: 0 5px 0 #800000; }
    }
    .credits-btn {
        animation: rgb-glow 2s linear infinite;
        font-family: 'Courier New', Courier, monospace !important;
        color: white !important;
    }

    #creditsOverlay {
        position:absolute; inset:0; display:none; flex-direction:column; align-items:center;
        background:black; color:white; z-index:300; overflow:hidden;
    }
    #creditsContent {
        position:absolute; top:100%; width:100%; text-align:center;
        transition: transform 35s linear;
    }
    .credit-text { font-size:24px; margin:20px 0; line-height:1.8; }
    .close-credits {
        position:absolute; top:20px; right:20px; background:#e74c3c; color:white;
        border:none; border-radius:50%; width:45px; height:45px; font-size:26px;
        cursor:pointer; z-index:310; display:flex; align-items:center; justify-content:center;
        box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
    }

    .reset-btn { background: #e74c3c !important; box-shadow: 0 5px 0 #c0392b !important; color: white !important; margin-top: 20px !important; font-size: 14px !important; }
    .lobby-btn { background: #3498db; box-shadow: 0 5px 0 #2980b9; }

    #ui { 
        position:absolute;top:20px;left:0;right:0;z-index:20; 
        font-size:28px;color:white;
        text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, 3px 3px 5px rgba(0,0,0,0.8);
        display:flex;flex-direction:column;align-items:flex-start;padding:0 30px;pointer-events: none;
        font-family: 'Quicksand', sans-serif; font-weight: 700;
    }
    #rocketTimerUI, #cheatTimerUI, #goldRainTimerUI { 
        position:absolute; bottom:40px; left:50%; transform: translateX(-50%); 
        padding:15px 30px; border-radius:50px; color:white; font-size:24px; 
        display:none; z-index:20; border: 4px solid #fff; 
        box-shadow: 0 0 20px rgba(0,0,0,0.3); 
        pointer-events: none; 
    }
    #rocketTimerUI { background:rgba(231, 76, 60, 0.9); }
    #cheatTimerUI { background:rgba(46, 204, 113, 0.9); }
    #goldRainTimerUI { background:rgba(241, 196, 15, 0.9); border-color: #f39c12; animation: warningPulse 0.5s infinite alternate; }

    @keyframes warningPulse { from { transform: translateX(-50%) scale(1); } to { transform: translateX(-50%) scale(1.1); } }
    @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOutOverlay { from { opacity: 1; } to { opacity: 0; } }
    @keyframes fadeInText { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #getReadyUI {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: white; text-align: center; z-index: 30; pointer-events: none; display: none;
    }
    @keyframes pulseText { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { scale(1); } }
    .pulse { animation: pulseText 1.5s infinite ease-in-out; }

    .shop-tabs { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 20px; }
    .tab-btn { background: #7f8c8d; min-width: 80px; font-size: 12px; padding: 10px; margin: 2px; }
    .tab-active { background: #e67e22 !important; box-shadow: 0 5px 0 #d35400 !important; }
    .setting-row { background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; width: 320px; margin-bottom: 10px; }

    #redeemInput {
        padding:15px; font-size:20px; border-radius:15px; border:3px solid #2ecc71; margin:20px; 
        width:250px; text-align:center; outline: none; font-family: 'Quicksand', sans-serif; font-weight: 700;
        background: #ecf0f1;
    }
    #redeemMsg {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(46, 204, 113, 0.95); color: white; padding: 40px; border-radius: 30px;
        z-index: 3000; font-size: 30px; display: none; border: 5px solid white;
        animation: breakPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 0 50px rgba(0,0,0,0.5); text-align:center;
    }

    #leagueUI { font-size: 18px; color: #f1c40f; margin-top: 5px; }
    .rank-bronz { color: #cd7f32; }
    .rank-demir { color: #a19d94; }
    .rank-altin { color: #f1c40f; text-shadow: 0 0 5px #f39c12; }
    .rank-elmas { color: #3498db; text-shadow: 0 0 8px #2980b9; }
    .rank-maks { animation: rgbText 1s infinite linear; font-weight: 900; }
    
    #leagueProgressContainer {
        width: 250px; height: 15px; background: rgba(255,255,255,0.2);
        border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #fff;
    }
    #leagueProgressBar {
        width: 0%; height: 100%; background: #2ecc71; transition: width 0.5s ease-out;
    }

    /* ADMƒ∞N BUTONU STƒ∞Lƒ∞ */
    #adminMoneyBtn {
        display: none;
        background: #9b59b6;
        box-shadow: 0 5px 0 #8e44ad;
        margin-top: 10px;
    }
</style>
</head>
<body>

<canvas id="game"></canvas>

<audio id="bgMusic" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
</audio>

<div id="redeemMsg"></div>

<div id="getReadyUI">
    <p style="color: #ff3e3e; font-size: 18px; margin-bottom: 15px; text-shadow: 2px 2px 3px #000;">1. ƒ∞pucu: 10'un katlarƒ±nda 100üí∞ ve 50'nin katlarƒ±nda 1000üí∞ kazanƒ±rsƒ±n</p>
    <p class="pulse" style="font-size: 24px; background: rgba(0,0,0,0.6); padding: 15px 30px; border-radius: 30px; border: 2px solid #f1c40f; text-shadow: 2px 2px 4px #000; display: inline-block; margin: 0;">BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN</p>
    <p style="color: #ff3e3e; font-size: 18px; margin-top: 15px; text-shadow: 2px 2px 3px #000;">2. ƒ∞pucu: Ayrƒ±ca 50'nin katlarƒ±nda tekrardan markete eri≈üebilirsin</p>
</div>

<div id="breakOverlay">
    <h1 class="break-title">Bƒ∞RAZ MOLANIN SIRASI DEƒûƒ∞L Mƒ∞?</h1>
    <div id="breakShop" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; width: 400px; margin-bottom: 20px;">
        <p id="breakGold" style="color:#f1c40f; font-size: 20px;">C√ºzdan: üí∞ 0</p>
        <div id="breakShopContent"></div>
    </div>
    <button id="breakContinueBtn" class="btn" style="background:#2ecc71; box-shadow: 0 5px 0 #27ae60;">DEVAM ET</button>
</div>

<div id="nickMenu" style="display:none">
    <h1 style="font-size: 40px; text-shadow: 3px 3px 0 #d4ac0d;">HO≈û GELDƒ∞N!</h1>
    <p>L√ºtfen bir lakap (nick) girin:</p>
    <input type="text" id="nickInput" placeholder="Nickiniz..." maxlength="12">
    <button id="nickSaveBtn" class="btn">KAYDET</button>
</div>

<div id="langMenu">
    <h2 style="margin-bottom: 30px;">Dƒ∞L SE√áƒ∞N / SELECT LANGUAGE</h2>
    <div class="lang-opt" onclick="finishSetup()">
        <span style="font-size:35px">üáπüá∑</span>
        <div style="text-align:left">
            <div style="font-size:20px">T√ºrk√ße</div>
            <div style="font-size:12px; color:#aaa">Varsayƒ±lan Dil</div>
        </div>
    </div>
    <div class="lang-opt" onclick="alert('Tek ki≈üinin yaptƒ±ƒüƒ± bir oyunda dil desteƒüi beklemek mi? G√ºld√ºrme beni :D')">
        <span style="font-size:35px">üåê</span>
        <div style="text-align:left">
            <div style="font-size:20px">English / Other</div>
            <div style="font-size:12px; color:#aaa">Coming Soon ‚û°Ô∏è</div>
        </div>
    </div>
</div>

<div id="demoOverlay">
    <p style="font-size: 28px; padding: 0 30px; margin-bottom: 20px;">Daha demo halinde, birka√ß eksiklik yada birka√ß hata olabilir. M√¢ruz g√∂r√ºn√ºz.</p>
    <p style="font-size: 18px; color: #f1c40f;">(AntiRollsy tarafƒ±ndan geli≈ütirildi)</p>
    <div id="continueText">DEVAM ETMEK ƒ∞√áƒ∞N DOKUN</div>
</div>

<div id="rocketTimerUI">üöÄ ROKET: <span id="rTime">0.0</span>s</div>
<div id="cheatTimerUI">üë®‚Äçüíª Hƒ∞LEBAZ AKTƒ∞F: <span id="cScore">20</span> KALDI</div>
<div id="goldRainTimerUI">‚ö†Ô∏è ALTIN YAƒûMURU: <span id="gTime">20.0</span>s</div>

<div id="creditsOverlay">
    <button id="creditsCloseBtn" class="close-credits">‚úñ</button>
    <div id="creditsContent">
        <div class="credit-text">
            <br><br><br>
            <h1 style="color:#f1c40f; font-size: 45px;">MADEM MERAK ETTƒ∞N:</h1><br>
            <p>YAPIMCI: <span style="color:#2ecc71">AntiRollsy</span></p>
            <p>Yardƒ±mcƒ±: <span style="color:#2ecc71">ThankGard ü§†</span></p>
            <p>Kodlama & Yazƒ±lƒ±m: <span style="color:#2ecc71">AntiRollsy</span></p>
            <p>G√∂rsel Efektler: <span style="color:#2ecc71">AntiRollsy</span></p>
            <p>Ses Efekt Tasarƒ±mƒ±: <span style="color:#2ecc71">AntiRollsy</span></p>
            <p>Arka Plan Tasarƒ±mƒ±: <span style="color:#2ecc71">AntiRollsy</span></p>
            <p>Oyun Fikri: <span style="color:#2ecc71">AntiRollsy</span></p>
            <p>Yapƒ±m S√ºresi: <span style="color:#e67e22">+48 Saat</span></p><br><br>
            <p style="font-size: 32px;">Oyun bitince ne oluyor?<br><b style="color:#e74c3c; font-size: 42px;">Bƒ∞TMESƒ∞N Nƒ∞YE Bƒ∞Tƒ∞YO</b></p><br>
            <p>Sadece eƒülenmene bak dostum.</p>
            <br><br><br><br><br>
        </div>
    </div>
</div>

<div id="menu">
    <div id="mainButtons">
        <h1 style="font-size: 50px; margin: 0; text-shadow: 3px 3px 0 #000;">FLAPPY BIRD PRO</h1>
        <p id="highScoreDisplay" style="color: #2ecc71; font-size: 20px; margin: 5px 0;">En Y√ºksek Skor: 0</p>
        <p id="totalGoldDisplay" style="font-size: 24px; margin-bottom: 10px;">üí∞ 0</p>
        <button id="playBtn" class="btn">OYNA</button>
        <button id="shopOpenBtn" class="btn" style="background: #e67e22; box-shadow: 0 5px 0 #d35400;">MAƒûAZA</button>
        <div style="display: flex; justify-content: center; gap: 0;">
            <button id="setOpenBtn" class="btn" style="background: #95a5a6; box-shadow: 0 5px 0 #7f8c8d;">AYARLAR</button>
            <button id="creditsOpenBtn" class="btn credits-btn">YAPIMCILAR</button>
        </div>
        <button id="redeemOpenBtn" class="btn" style="background: #2ecc71; box-shadow: 0 5px 0 #27ae60; color: white;">REDEEM</button>
        <button id="adminMoneyBtn" class="btn">üí∞ PARA BAS (+1000)</button>
    </div>
    <div id="deathScreen" style="display:none">
        <h1 style="color:#e74c3c; margin:0;">GEBERDƒ∞N!</h1>
        <p id="sessionResult" style="font-size:20px; margin:5px;"></p>
        
        <div id="rankDisplayArea" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 20px; margin: 10px 0;">
            <div id="currentRankLabel" style="font-size: 22px; margin-bottom: 5px;">Lƒ∞G: BRONZ</div>
            <div id="leagueProgressContainer"><div id="leagueProgressBar"></div></div>
            <div id="rankPointsLabel" style="font-size: 16px;">0 / 500 LP</div>
        </div>

        <button id="retryBtn" class="btn">TEKRAR DENE</button>
        <button id="lobbyBtn" class="btn lobby-btn">LOBƒ∞YE D√ñN</button>
    </div>
</div>

<div id="redeemMenu">
    <h2>KOD KULLAN</h2>
    <p>Hediyeni almak i√ßin kodu gir:</p>
    <input type="text" id="redeemInput" placeholder="KODU YAZINIZ..." maxlength="20">
    <button id="redeemCheckBtn" class="btn">KULLAN</button>
    <button id="redeemCloseBtn" class="btn lobby-btn">GERƒ∞</button>
</div>

<div id="shopMenu">
    <h2>MAƒûAZA</h2>
    <div class="shop-tabs">
        <button id="tabColors" class="btn tab-btn tab-active">RENKLER</button>
        <button id="tabTrails" class="btn tab-btn">ƒ∞ZLER</button>
        <button id="tabItems" class="btn tab-btn">E≈ûYALAR</button>
        <button id="tabAccs" class="btn tab-btn">AKSESUAR</button>
    </div>
    <p id="shopGold" style="color:#f1c40f; margin-top:0;">C√ºzdan: üí∞ 0</p>
    <div id="shopContent"></div>
    <p style="color: #f1c40f; font-size: 12px; margin-top: -5px;">A≈ûAƒûIYA KAYDIR</p>
    <button id="shopCloseBtn" class="btn lobby-btn">GERƒ∞ D√ñN</button>
</div>

<div id="settingsMenu">
    <h2>AYARLAR</h2>
    <div class="setting-row">
        <p>Yer√ßekimi: <span id="gravVal">0.35</span></p>
        <input type="range" id="gravSlider" min="0.10" max="1.00" step="0.05" value="0.35" style="width:100%">
    </div>
    <div class="setting-row">
        <p>Zƒ±plama Boyutu: <span id="jumpVal">9.0</span></p>
        <input type="range" id="jumpSlider" min="5.0" max="15.0" step="0.5" value="9.0" style="width:100%">
    </div>
    <div class="setting-row">
        <p>Ba≈ülangƒ±√ß Hƒ±zƒ±: <span id="speedVal">4</span></p>
        <input type="range" id="speedSlider" min="3" max="8" step="0.5" value="4" style="width:100%">
    </div>
    <div class="setting-row">
        <p>M√ºzik: <button id="musicToggleBtn" class="btn" style="min-width:60px; padding:5px 10px; margin:0">A√áIK</button></p>
    </div>
    <button id="resetAccountBtn" class="btn reset-btn">HESABI SIFIRLA</button>
    <button id="setCloseBtn" class="btn" style="margin-top: 10px;">GERƒ∞</button>
</div>

<div id="ui">
    <div style="display:flex; gap: 20px; align-items: center;">
        <span id="score">(SKOR) 0</span>
        <span id="gold">üí∞ 0</span>
        <span id="totalDeathUI">üíÄ 0</span>
        <span id="leagueUI">Bronz</span>
    </div>
</div>

<script>
const canvas = document.getElementById("game"), ctx = canvas.getContext("2d");
const menu = document.getElementById("menu"), settingsMenu = document.getElementById("settingsMenu"), shopMenu = document.getElementById("shopMenu"), redeemMenu = document.getElementById("redeemMenu");
const nickMenu = document.getElementById("nickMenu"), langMenu = document.getElementById("langMenu"), nickInput = document.getElementById("nickInput");
const mainButtons = document.getElementById("mainButtons"), deathScreen = document.getElementById("deathScreen");
const rocketUI = document.getElementById("rocketTimerUI"), rTimeText = document.getElementById("rTime");
const cheatUI = document.getElementById("cheatTimerUI"), cScoreText = document.getElementById("cScore");
const goldRainUI = document.getElementById("goldRainTimerUI"), gTimeText = document.getElementById("gTime");
const bgMusic = document.getElementById("bgMusic");
const creditsOverlay = document.getElementById("creditsOverlay"), creditsContent = document.getElementById("creditsContent");
const demoOverlay = document.getElementById("demoOverlay");
const getReadyUI = document.getElementById("getReadyUI");
const breakOverlay = document.getElementById("breakOverlay"), breakShopContent = document.getElementById("breakShopContent"), breakGoldText = document.getElementById("breakGold");
const adminBtn = document.getElementById("adminMoneyBtn");

bgMusic.volume = 0.3; 

let playerNick = localStorage.getItem("playerNick") || "";
let setupComplete = localStorage.getItem("setupComplete") === "true";
let state = "menu", score = 0, frame = 0, sessionGold = 0;
let totalGold = parseInt(localStorage.getItem("totalGold")) || 0;
let highScore = parseInt(localStorage.getItem("highScore")) || 0;
let totalDeaths = parseInt(localStorage.getItem("totalDeaths")) || 0;
let isAdmin = localStorage.getItem("isAdmin") === "true";

let leaguePoints = parseInt(localStorage.getItem("leaguePoints")) || 0;
let gravity = 0.35; 
let jumpPower = -9; 
let baseSpeed = 4; 
let speed = 4;

let musicEnabled = localStorage.getItem("musicEnabled") === "false" ? false : true;
let birdColor = localStorage.getItem("birdColor") || "#f5c400";
let ownedColors = JSON.parse(localStorage.getItem("ownedColors")) || ["#f5c400"];
let currentTrail = localStorage.getItem("currentTrail") || "none";
let ownedTrails = JSON.parse(localStorage.getItem("ownedTrails")) || ["none"];
let birdHistory = []; 
let currentAcc = localStorage.getItem("currentAcc") || "none";
let ownedAccs = JSON.parse(localStorage.getItem("ownedAccs")) || ["none"];

let hasRocket = false, hasX2Counter = false, hasCheatMode = false, hasBereket = false;
let lastBereketTime = parseInt(localStorage.getItem("lastBereketTime")) || 0; 
let hasShrink = false, shrinkActive = false, goldRainActive = false, goldRainTime = 0, cheatActive = false;
let currentTab = "colors", demoShownInSession = false, shopInterval = null; 
let rocketActive = false, rocketTime = 0, safeMode = false, safeTimer = 0;

const bird = { x: 120, y: 300, vy: 0 };
let pipes = [], particles = [], clouds = [], mountains = [], collectibleGolds = [], stars = [];
const gap = 185;
let isNight = false, skyAlpha = 0;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let rocketSoundSource = null;

function playSound(type) {
    const now = audioCtx.currentTime;
    if (type === 'jump') {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(350, now);
        o.frequency.exponentialRampToValueAtTime(550, now + 0.1);
        g.gain.setValueAtTime(0.1, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        o.start(); o.stop(now + 0.1);
    } else if (type === 'coin') {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(950, now);
        o.frequency.setValueAtTime(1300, now + 0.08);
        g.gain.setValueAtTime(0.2, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        o.start(); o.stop(now + 0.3);
    } else if (type === 'hit') {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'square'; o.frequency.setValueAtTime(150, now);
        g.gain.setValueAtTime(0.1, now); g.linearRampToValueAtTime(0, now + 0.2);
        o.start(); o.stop(now + 0.2);
    } else if (type === 'gameover') {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'sawtooth'; o.frequency.setValueAtTime(200, now);
        o.frequency.linearRampToValueAtTime(50, now + 0.6);
        g.gain.setValueAtTime(0.2, now); g.gain.linearRampToValueAtTime(0, now + 0.6);
        o.start(); o.stop(now + 0.6);
    } else if (type === 'rocket_start') {
        const bufferSize = audioCtx.sampleRate * 2;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
        rocketSoundSource = audioCtx.createBufferSource();
        rocketSoundSource.buffer = buffer; rocketSoundSource.loop = true;
        const g = audioCtx.createGain(); const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 600;
        rocketSoundSource.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.15, now + 0.5);
        rocketSoundSource.gainNode = g; rocketSoundSource.start();
    } else if (type === 'rocket_stop') {
        if (rocketSoundSource) {
            const g = rocketSoundSource.gainNode;
            g.gain.linearRampToValueAtTime(0, now + 0.3);
            setTimeout(() => { try { rocketSoundSource.stop(); } catch(e){} rocketSoundSource = null; }, 300);
        }
    }
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initBG(); }
window.onresize = resize; resize();

function initBG() {
    clouds = []; mountains = []; stars = [];
    for(let i=0; i<6; i++) clouds.push({x: Math.random()*canvas.width, y: Math.random()*250, s: Math.random()*0.5+0.2, r: 30 + Math.random()*20});
    for(let i=0; i<8; i++) mountains.push({x: i*400, h: 150 + Math.random()*200, w: 400 + Math.random()*200, color: '#3d9489', speed: 0.3});
    for(let i=0; i<8; i++) mountains.push({x: i*300, h: 80 + Math.random()*120, w: 250 + Math.random()*150, color: '#4db3a4', speed: 0.7});
    for(let i=0; i<50; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height*0.7, size: Math.random()*2, opacity: Math.random()});
}

function updateMusic() {
    if(musicEnabled) { bgMusic.play().catch(() => {}); document.getElementById("musicToggleBtn").innerText = "A√áIK"; } 
    else { bgMusic.pause(); document.getElementById("musicToggleBtn").innerText = "KAPALI"; }
}

function spawnConfetti() {
    for(let i=0; i<80; i++) {
        particles.push({ x: canvas.width/2, y: canvas.height/2, vx: Math.random()*16-8, vy: Math.random()*16-8, c: `hsl(${Math.random()*360}, 100%, 50%)`, life: 100, size: Math.random()*6+2 });
    }
}

function handlePlayClick() {
    if (!demoShownInSession) {
        menu.style.display = "none";
        demoOverlay.style.display = "flex";
        demoOverlay.classList.remove("fadeOut");
        demoShownInSession = true;
    } else {
        prepareGame();
    }
}

demoOverlay.onclick = () => {
    if (demoOverlay.style.display === "flex") {
        demoOverlay.classList.add("fadeOut");
        setTimeout(() => {
            demoOverlay.style.display = "none";
            prepareGame();
        }, 500);
    }
};

function prepareGame() {
    state = "ready";
    menu.style.display = "none";
    getReadyUI.style.display = "block";
    score = 0; sessionGold = 0; frame = 0; 
    bird.y = canvas.height / 2; bird.vy = 0; 
    pipes = []; particles = []; birdHistory = []; collectibleGolds = [];
    speed = baseSpeed;
    isNight = false; skyAlpha = 0;
    rocketUI.style.display = "none";
    cheatUI.style.display = "none";
    goldRainUI.style.display = "none";
    goldRainActive = false;
    shrinkActive = false;
    updateUI();
}

function startActualGame() {
    if(state !== "ready") return;
    state = "play";
    getReadyUI.style.display = "none";
    if(musicEnabled) bgMusic.play();
    
    if(hasBereket) {
        goldRainActive = true;
        goldRainTime = 20 * 60;
        goldRainUI.style.display = "block";
        hasBereket = false;
    }

    if(hasShrink) {
        shrinkActive = true;
        hasShrink = false;
    }

    if(hasCheatMode) {
        cheatActive = true;
        cheatUI.style.display = "block";
        cScoreText.innerText = "20";
    } else {
        cheatActive = false;
    }
    if (hasRocket && !rocketActive) { activateRocket(); } 
    else if (!rocketActive) { bird.vy = jumpPower; playSound('jump'); }
}

function activateRocket() {
    rocketActive = true; rocketTime = 30 * 60; speed = 13; 
    rocketUI.style.display = "block"; hasRocket = false; 
    playSound('rocket_start');
}

function showBreakScreen() {
    state = "break";
    bgMusic.pause();
    spawnConfetti();
    breakOverlay.style.display = "flex";
    renderBreakShop();
}

function renderBreakShop() {
    breakGoldText.innerText = "C√ºzdan: üí∞ " + totalGold;
    breakShopContent.innerHTML = `
        <div class="shop-item" style="height:70px; width: 100%; box-sizing: border-box;">
            <div style="font-size:25px">üöÄ</div>
            <div style="font-size:11px; text-align:left; max-width:180px"><b>ROKET:</b> 30s Hƒ±zlƒ± Otopilot!</div>
            <button id="breakBuyRocket" class="btn" style="min-width:80px; background:#e74c3c; font-size:14px;">${hasRocket ? "HAZIR" : "500üí∞"}</button>
        </div>`;
    
    document.getElementById("breakBuyRocket").onclick = () => {
        if (!hasRocket && totalGold >= 500) {
            totalGold -= 500;
            hasRocket = true;
            saveData();
            renderBreakShop();
            playSound('coin');
            updateUI();
        }
    };
}

function update() {
    frame++;
    if (state === "ready") {
        bird.y = (canvas.height / 2) + Math.sin(frame * 0.1) * 15;
        return;
    }
    if (state !== "play") return;

    let cycle = Math.floor(score / 20);
    isNight = cycle % 2 !== 0;

    if (isNight && skyAlpha < 1) skyAlpha += 0.01;
    if (!isNight && skyAlpha > 0) skyAlpha -= 0.01;

    birdHistory.push({x: bird.x, y: bird.y});
    if(birdHistory.length > 25) birdHistory.shift();

    if (!rocketActive && !goldRainActive && frame % 300 === 0) { speed += 0.05; }
    let spawnInterval = rocketActive ? 40 : Math.max(70, 110 - (speed * 5)); 
    
    if (goldRainActive) {
        goldRainTime--;
        gTimeText.innerText = (goldRainTime / 60).toFixed(1);
        if (frame % 15 === 0) {
            collectibleGolds.push({ x: canvas.width, y: 50 + Math.random() * (canvas.height - 150), size: 15 });
        }
        if (goldRainTime <= 0) {
            goldRainActive = false;
            goldRainUI.style.display = "none";
            spawnConfetti();
        }
    }

    if (!safeMode && !goldRainActive && frame % Math.floor(spawnInterval) === 0) {
        pipes.push({ x: canvas.width, y: Math.random()*(canvas.height-380)+80, scored: false });
    }
    
    if (rocketActive) {
        rocketTime--; rTimeText.innerText = (rocketTime / 60).toFixed(1);
        let targetY = canvas.height / 2;
        let nextPipe = pipes.find(p => p.x + 80 > bird.x - 20);
        if (nextPipe) targetY = nextPipe.y + (gap / 2);
        bird.y += (targetY - bird.y) * 0.18;
        bird.vy = 0;
        if (rocketTime <= 0) { 
            rocketActive = false; speed = baseSpeed + (score * 0.01); 
            rocketUI.style.display = "none"; safeMode = true; safeTimer = 180; spawnConfetti(); 
            playSound('rocket_stop');
        }
    } else { bird.vy += gravity; bird.y += bird.vy; }

    if (safeMode) { safeTimer--; if(safeTimer <= 0) safeMode = false; }
    
    collectibleGolds.forEach((g, idx) => {
        g.x -= speed;
        let bSize = shrinkActive ? 25 : 40; 
        if (bird.x + bSize > g.x && bird.x - bSize < g.x + g.size && bird.y + bSize > g.y && bird.y - bSize < g.y + g.size) {
            collectibleGolds.splice(idx, 1);
            sessionGold += 10; totalGold += 10;
            playSound('coin');
            updateUI();
        }
        if (g.x < -50) collectibleGolds.splice(idx, 1);
    });

    pipes.forEach((p, index) => {
        p.x -= speed;
        let bW = shrinkActive ? 9 : 18;
        let bH = shrinkActive ? 7 : 14;
        if (bird.x + bW > p.x && bird.x - bW < p.x + 80 && (bird.y - bH < p.y || bird.y + bH > p.y + gap)) {
            if (!rocketActive && !safeMode && !cheatActive) gameOver();
        }
        if (p.scored === false && p.x + 80 < bird.x) { 
            p.scored = true; 
            score++; 
            if(cheatActive) {
                let remaining = 20 - score;
                cScoreText.innerText = Math.max(0, remaining);
                if(score >= 20) { cheatActive = false; cheatUI.style.display = "none"; spawnConfetti(); }
            }
            checkMilestones(); 
        }
        if (p.x < -100) pipes.splice(index, 1);
    });
    
    for(let i=particles.length-1; i>=0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--; if(p.life <= 0) particles.splice(i, 1); }
    if (bird.y > canvas.height - 40 || bird.y < 0) { if(!rocketActive && !safeMode && !cheatActive) gameOver(); }
}

function checkMilestones() {
    if(score > 0 && score % 50 === 0) { 
        sessionGold += 1000; totalGold += 1000; saveData(); 
        playSound('coin');
        showBreakScreen();
    } 
    else if(score > 0 && score % 10 === 0) { 
        let reward = hasX2Counter ? 100 : 50; 
        sessionGold += reward; totalGold += reward; saveData(); playSound('coin'); 
    }
    updateUI();
}

function drawTrail() {
    if (currentTrail === "none" || birdHistory.length < 2) return;
    ctx.save();
    
    if(currentTrail === "child") {
        let childPos = birdHistory[0]; 
        ctx.translate(childPos.x - 30, childPos.y + 10);
        ctx.scale(0.5, 0.5);
        ctx.fillStyle = birdColor === "rgb" ? `hsl(${frame * 5 % 360}, 80%, 60%)` : birdColor;
        ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.beginPath(); ctx.ellipse(0, 0, 20, 16, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(8, -5, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(10, -5, 2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#ff7f00"; ctx.beginPath(); ctx.moveTo(15, -2); ctx.lineTo(22, 2); ctx.lineTo(15, 6); ctx.fill(); ctx.stroke();
        ctx.scale(2, 2);
        ctx.fillStyle = "white"; ctx.font = "bold 10px 'Quicksand'"; ctx.textAlign = "center";
        ctx.strokeStyle = "black"; ctx.lineWidth = 2;
        let childName = "Minik " + playerNick;
        ctx.strokeText(childName, 0, -20); ctx.fillText(childName, 0, -20);
        ctx.restore();
        return;
    }

    for (let i = 0; i < birdHistory.length - 1; i++) {
        let p1 = birdHistory[i]; let p2 = birdHistory[i+1];
        let alpha = i / birdHistory.length;
        let tColor = currentTrail;
        if(currentTrail === "rgb") tColor = `hsl(${(frame * 5 + i * 10) % 360}, 80%, 50%)`;
        ctx.strokeStyle = tColor; ctx.globalAlpha = alpha * 0.6; ctx.lineCap = "round";
        const offsets = shrinkActive ? [-3, 0, 3] : [-6, 0, 6];
        offsets.forEach(off => {
            ctx.lineWidth = (shrinkActive ? 2 : 4) * alpha; ctx.beginPath();
            ctx.moveTo(p1.x - (birdHistory.length - i) * speed, p1.y + off);
            ctx.lineTo(p2.x - (birdHistory.length - (i+1)) * speed, p2.y + off);
            ctx.stroke();
        });
    }
    ctx.restore();
}

function drawBird() {
    if(state === "play") drawTrail();
    ctx.save(); ctx.translate(bird.x, bird.y);
    if(shrinkActive) ctx.scale(0.5, 0.5);
    let finalBirdColor = birdColor;
    if (birdColor === "rgb") { finalBirdColor = `hsl(${frame * 5 % 360}, 80%, 60%)`; }
    if (rocketActive) {
        ctx.fillStyle = "#95a5a6"; ctx.beginPath(); ctx.roundRect(-50, -8, 45, 16, 4); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.moveTo(-5, -8); ctx.lineTo(10, 0); ctx.lineTo(-5, 8); ctx.fill();
        ctx.fillStyle = "#34495e"; ctx.fillRect(-55, -5, 8, 10);
        let fireW = 25 + Math.random()*30;
        let grad = ctx.createLinearGradient(-55, 0, -55-fireW, 0);
        grad.addColorStop(0, "#ff0000"); grad.addColorStop(0.4, "#ff9900"); grad.addColorStop(1, "transparent");
        ctx.fillStyle = grad; ctx.beginPath(); ctx.moveTo(-55, -6); ctx.lineTo(-55-fireW, 0); ctx.lineTo(-55, 6); ctx.fill();
    }
    if ((safeMode || cheatActive || goldRainActive) && frame % 10 < 5) ctx.globalAlpha = 0.3;
    ctx.rotate(rocketActive ? 0 : Math.max(-0.4, Math.min(0.4, bird.vy / 20)));
    
    ctx.fillStyle = finalBirdColor; ctx.strokeStyle = "black"; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.ellipse(0, 0, 20, 16, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
    
    if(currentAcc === "bjk") {
        ctx.save(); ctx.fillStyle = "white"; ctx.beginPath(); ctx.ellipse(0, 5, 16, 11, 0, 0, Math.PI * 2); ctx.fill(); ctx.clip();
        ctx.fillStyle = "black"; for(let i = -20; i < 20; i += 10) { ctx.fillRect(i, -10, 5, 30); } ctx.restore();
        ctx.strokeStyle = "black"; ctx.lineWidth = 1; ctx.beginPath(); ctx.ellipse(0, 5, 16, 11, 0, 0, Math.PI * 2); ctx.stroke();
    } else if(currentAcc === "gs") {
        ctx.save(); ctx.fillStyle = "#A32638"; ctx.beginPath(); ctx.ellipse(0, 5, 16, 11, 0, 0, Math.PI * 2); ctx.fill(); ctx.clip();
        ctx.fillStyle = "#FEB100"; for(let i = -20; i < 20; i += 12) { ctx.fillRect(i, -10, 6, 30); } ctx.restore();
        ctx.strokeStyle = "black"; ctx.lineWidth = 1.2; ctx.beginPath(); ctx.ellipse(0, 5, 16, 11, 0, 0, Math.PI * 2); ctx.stroke();
        ctx.fillStyle = "white"; ctx.font = "8px Arial"; ctx.fillText("‚≠ê", -3, 6);
    } else if(currentAcc === "fb") {
        ctx.save(); ctx.fillStyle = "#002366"; ctx.beginPath(); ctx.ellipse(0, 5, 16, 11, 0, 0, Math.PI * 2); ctx.fill(); ctx.clip();
        ctx.fillStyle = "#FED500"; for(let i = -20; i < 20; i += 10) { ctx.fillRect(i, -10, 5, 30); } ctx.restore();
        ctx.strokeStyle = "black"; ctx.lineWidth = 1; ctx.beginPath(); ctx.ellipse(0, 5, 16, 11, 0, 0, Math.PI * 2); ctx.stroke();
    } else if(currentAcc === "adidas") {
        ctx.save(); ctx.beginPath(); ctx.ellipse(0, 3, 20.5, 14, 0, 0, Math.PI * 2); ctx.clip();
        ctx.fillStyle = "black"; ctx.fillRect(-22, -2, 45, 25);
        ctx.fillStyle = "white"; for(let i=0; i<3; i++) { ctx.fillRect(-18 + (i*3), -5, 1.5, 25); ctx.fillRect(14 + (i*3), -5, 1.5, 25); }
        ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, -2); ctx.lineTo(0, 18); ctx.stroke();
        ctx.restore();
        ctx.save(); ctx.translate(5, -13); ctx.rotate(-0.1); ctx.fillStyle = "black"; ctx.strokeStyle = "black"; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(0, 0, 13, Math.PI, 0); ctx.fill(); ctx.stroke();
        ctx.beginPath(); ctx.ellipse(10, 0, 12, 3, 0.2, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "white"; ctx.fillRect(-6, -11, 2, 7); ctx.fillRect(-3, -12.5, 2, 8); ctx.fillRect(0, -13, 2, 7);
        ctx.restore();
    }

    ctx.fillStyle = "white"; ctx.beginPath(); ctx.ellipse(-8, 3, 11, 8, (rocketActive ? 0 : Math.sin(frame*0.2)*0.6), 0, Math.PI * 2); ctx.fill(); ctx.stroke();
    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(10, -6, 7, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
    ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(12, -6, 3, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = "#ff7f00"; ctx.beginPath(); ctx.moveTo(16, -2); ctx.quadraticCurveTo(28, 3, 16, 9); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.restore();

    ctx.save(); ctx.translate(bird.x, bird.y); ctx.fillStyle = "white"; ctx.font = "bold 14px 'Quicksand'"; ctx.textAlign = "center"; ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.strokeText(playerNick, 0, -35); ctx.fillText(playerNick, 0, -35); ctx.restore();
}

function drawPipes() {
    pipes.forEach(p => {
        let grad = ctx.createLinearGradient(p.x, 0, p.x + 80, 0);
        grad.addColorStop(0, "#73bf2e"); grad.addColorStop(0.5, "#9de64e"); grad.addColorStop(1, "#558022");
        ctx.fillStyle = grad; ctx.strokeStyle = "black"; ctx.lineWidth = 3;
        ctx.fillRect(p.x, 0, 80, p.y); ctx.strokeRect(p.x, 0, 80, p.y);
        ctx.fillRect(p.x, p.y + gap, 80, canvas.height); ctx.strokeRect(p.x, p.y + gap, 80, canvas.height);
        ctx.fillRect(p.x - 5, p.y - 25, 90, 25); ctx.strokeRect(p.x - 5, p.y - 25, 90, 25);
        ctx.fillRect(p.x - 5, p.y + gap, 90, 25); ctx.strokeRect(p.x - 5, p.y + gap, 90, 25);
    });
    collectibleGolds.forEach(g => {
        ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(g.x, g.y, 25, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#d4ac0d"; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = "white"; ctx.font = "bold 18px Arial"; ctx.fillText("üí∞", g.x-11, g.y+7);
    });
}

function drawBG() {
    let skyDay1 = "#4eb0ca", skyDay2 = "#99e1e5";
    let skyNight1 = "#0f0c29", skyNight2 = "#302b63";
    let skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
    skyGrad.addColorStop(0, skyDay1); skyGrad.addColorStop(1, skyDay2);
    ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (skyAlpha > 0) {
        ctx.save(); ctx.globalAlpha = skyAlpha;
        let nightGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        nightGrad.addColorStop(0, skyNight1); nightGrad.addColorStop(1, skyNight2);
        ctx.fillStyle = nightGrad; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.restore();
    }

    if (skyAlpha > 0) {
        ctx.save(); ctx.globalAlpha = skyAlpha;
        stars.forEach(s => { ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); });
        ctx.restore();
    }

    ctx.save();
    if (skyAlpha < 1) {
        ctx.globalAlpha = 1 - skyAlpha;
        ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(canvas.width - 100, 80, 40, 0, Math.PI * 2); ctx.fill();
        ctx.shadowBlur = 30; ctx.shadowColor = "#f1c40f"; ctx.stroke(); ctx.shadowBlur = 0;
    }
    if (skyAlpha > 0) {
        ctx.globalAlpha = skyAlpha;
        ctx.fillStyle = "#ecf0f1"; ctx.beginPath(); ctx.arc(canvas.width - 100, 80, 35, 0, Math.PI * 2); ctx.fill();
        ctx.shadowBlur = 20; ctx.shadowColor = "#fff"; ctx.stroke(); ctx.shadowBlur = 0;
        ctx.globalAlpha = skyAlpha * 0.4;
        ctx.fillStyle = "#bdc3c7"; ctx.beginPath(); ctx.arc(canvas.width - 110, 70, 8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(canvas.width - 90, 90, 5, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();

    mountains.forEach(m => {
        m.x -= (m.speed * (speed / baseSpeed)); if(m.x + m.w < 0) m.x = canvas.width;
        ctx.save();
        if (isNight) ctx.filter = `brightness(${1 - skyAlpha * 0.5})`;
        ctx.fillStyle = m.color; ctx.beginPath(); ctx.moveTo(m.x, canvas.height - 40); ctx.lineTo(m.x + m.w / 2, canvas.height - 40 - m.h); ctx.lineTo(m.x + m.w, canvas.height - 40); ctx.fill();
        ctx.restore();
    });

    if (skyAlpha < 1) {
        ctx.save(); ctx.globalAlpha = 1 - skyAlpha;
        clouds.forEach(c => {
            c.x -= (c.s * (speed/baseSpeed)); if(c.x < -150) c.x = canvas.width + 150;
            ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.arc(c.x+c.r, c.y-c.r/2, c.r*1.2, 0, Math.PI*2); ctx.arc(c.x+c.r*2, c.y, c.r, 0, Math.PI*2); ctx.fill();
        });
        ctx.restore();
    }

    ctx.fillStyle = "#73bf2e"; ctx.fillRect(0, canvas.height - 40, canvas.width, 10);
    ctx.fillStyle = "#ded895"; ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
    for(let i=0; i<canvas.width; i+=40) { ctx.fillStyle = "rgba(0,0,0,0.1)"; ctx.fillRect(i + (frame % 40), canvas.height - 35, 20, 5); }
}

function loop() { 
    ctx.clearRect(0, 0, canvas.width, canvas.height); drawBG(); drawPipes(); 
    particles.forEach(p => { ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.size, p.size); }); 
    drawBird(); update(); requestAnimationFrame(loop); 
}

function getRankData(points) {
    if (points >= 2000) return { name: "MAKSƒ∞MUM", class: "rank-maks", next: 2000, color: "rainbow" };
    if (points >= 1500) return { name: "ELMAS", class: "rank-elmas", next: 2000 };
    if (points >= 1000) return { name: "ALTIN", class: "rank-altin", next: 1500 };
    if (points >= 500) return { name: "DEMƒ∞R", class: "rank-demir", next: 1000 };
    return { name: "BRONZ", class: "rank-bronz", next: 500 };
}

function animateLeagueProgress(startPoints, gainedPoints) {
    let current = startPoints;
    let target = startPoints + gainedPoints;
    let step = gainedPoints / 60; 
    const interval = setInterval(() => {
        current += step;
        if (current >= target) {
            current = target;
            clearInterval(interval);
        }
        let data = getRankData(Math.floor(current));
        let prevRankThreshold = data.next - 500;
        let progress = ((current - prevRankThreshold) / 500) * 100;
        document.getElementById("currentRankLabel").innerText = "Lƒ∞G: " + data.name;
        document.getElementById("currentRankLabel").className = data.class;
        document.getElementById("leagueProgressBar").style.width = Math.min(100, progress) + "%";
        document.getElementById("rankPointsLabel").innerText = `${Math.floor(current)} / ${data.next} LP`;
        if(data.name === "MAKSƒ∞MUM") {
            document.getElementById("leagueProgressBar").style.width = "100%";
            document.getElementById("leagueProgressBar").style.animation = "rgb-glow 1s infinite linear";
            document.getElementById("rankPointsLabel").innerText = `${Math.floor(current)} LP (SON SEVƒ∞YE)`;
        }
    }, 16);
}

function gameOver() {
    state = "dead"; playSound('gameover'); playSound('rocket_stop');
    totalDeaths++;
    localStorage.setItem("totalDeaths", totalDeaths);
    if(score > highScore) { highScore = score; localStorage.setItem("highScore", highScore); }
    let oldPoints = leaguePoints;
    leaguePoints += score;
    localStorage.setItem("leaguePoints", leaguePoints);
    rocketActive = false; rocketUI.style.display = "none";
    cheatActive = false; cheatUI.style.display = "none";
    goldRainActive = false; goldRainUI.style.display = "none";
    shrinkActive = false;
    hasX2Counter = false; hasCheatMode = false;
    mainButtons.style.display = "none"; deathScreen.style.display = "block";
    document.getElementById("sessionResult").innerText = `Skor: ${score} | Toplam Altƒ±n: üí∞${totalGold}`;
    animateLeagueProgress(oldPoints, score);
    menu.style.display = "flex"; bgMusic.pause(); bgMusic.currentTime = 0;
    saveData();
    updateUI();
}

function updateUI() {
    document.getElementById("score").textContent = "Skor: " + score;
    document.getElementById("gold").textContent = "üí∞ " + sessionGold;
    document.getElementById("totalGoldDisplay").textContent = "üí∞ " + totalGold;
    document.getElementById("highScoreDisplay").textContent = "En Y√ºksek Skor: " + highScore;
    document.getElementById("totalDeathUI").textContent = "üíÄ: " + totalDeaths;
    let data = getRankData(leaguePoints);
    let leagueEl = document.getElementById("leagueUI");
    leagueEl.innerText = data.name;
    leagueEl.className = data.class;
    
    // Admin butonu kontrol√º
    if(isAdmin) adminBtn.style.display = "block";
}

function renderShop() {
    const content = document.getElementById("shopContent"); content.innerHTML = ""; document.getElementById("shopGold").innerText = "C√ºzdan: üí∞ " + totalGold;
    if (currentTab === "colors") {
        const colors = [{ n: "Klasik", c: "#f5c400", p: 0 }, { n: "Mavi", c: "#3498db", p: 100 }, { n: "Kƒ±rmƒ±zƒ±", c: "#e74c3c", p: 250 }, { n: "Mor", c: "#9b59b6", p: 500 }, { n: "RGB MODU", c: "rgb", p: 1000 }];
        colors.forEach(item => {
            let isOwned = ownedColors.includes(item.c);
            let btnText = isOwned ? (birdColor === item.c ? "SE√áƒ∞LDƒ∞" : "SE√á") : `üí∞ ${item.p}`;
            let colorPreview = item.c === "rgb" ? `<div style="background:linear-gradient(45deg, red, yellow, lime, cyan, blue, magenta); border:2px solid #fff; border-radius:50%; width:20px; height:20px;"></div>` : `<div style="background:${item.c}; border:2px solid #fff; border-radius:50%; width:20px; height:20px;"></div>`;
            content.innerHTML += `<div class="shop-item">${colorPreview}<span>${item.n}</span><button onclick="buyColor('${item.c}', ${item.p})" class="btn" style="min-width:80px; font-size:14px;">${btnText}</button></div>`;
        });
    } else if (currentTab === "trails") {
        const trails = [{ n: "Yok", c: "none", p: 0, d: "Sade" }, { n: "Kƒ±rmƒ±zƒ± ƒ∞z", c: "red", p: 400, d: "Ate≈üli" }, { n: "Siyah ƒ∞z", c: "black", p: 400, d: "Asil" }, { n: "Beyaz ƒ∞z", c: "white", p: 400, d: "Bulut" }, { n: "RGB ƒ∞Z", c: "rgb", p: 1000, d: "G√∂kku≈üaƒüƒ±" }, { n: "√áOCUK", c: "child", p: 2500, d: "Seni takip eder" }];
        trails.forEach(item => {
            let isOwned = ownedTrails.includes(item.c);
            let btnText = isOwned ? (currentTrail === item.c ? "SE√áƒ∞LDƒ∞" : "SE√á") : `üí∞ ${item.p}`;
            let colorPreview = item.c === "rgb" ? `<div style="background:linear-gradient(to right, red, orange, yellow, green, blue, violet); width:30px; height:10px; border-radius:5px;"></div>` : (item.c === "none" ? "‚ùå" : (item.c === "child" ? "üë∂" : `<div style="background:${item.c}; width:30px; height:10px; border-radius:5px; border:1px solid #fff;"></div>`));
            content.innerHTML += `<div class="shop-item"><div style="text-align:left; flex:1; margin-left:10px;"><div style="display:flex; align-items:center; gap:10px;">${colorPreview}<b>${item.n}</b></div><div style="font-size:10px; color:#aaa">${item.d}</div></div><button onclick="buyTrail('${item.c}', ${item.p})" class="btn" style="min-width:80px; font-size:14px;">${btnText}</button></div>`;
        });
    } else if (currentTab === "items") {
        let now = Date.now(); let bereketCooldown = 5 * 60 * 1000; let timeLeft = Math.ceil((lastBereketTime + bereketCooldown - now) / 1000); let bereketIsLocked = timeLeft > 0;
        let bText = hasBereket ? "HAZIR" : (bereketIsLocked ? `${timeLeft}s` : "150üí∞");
        let bStyle = (bereketIsLocked && !hasBereket) ? "background:#7f8c8d; cursor:not-allowed;" : "background:#f1c40f";
        let bAction = (bereketIsLocked && !hasBereket) ? "" : "buyBereket()";
        content.innerHTML = `<div class="shop-item" style="height:70px"><div style="font-size:25px">üß™</div><div style="font-size:11px; text-align:left; max-width:180px"><b>K√ú√á√úLME ƒ∞KSƒ∞Rƒ∞:</b> Ku≈üun boyutunu k√º√ß√ºlt√ºr!</div><button onclick="buyShrink()" class="btn" style="min-width:80px; background:#9b59b6; color:white;">${hasShrink ? "HAZIR" : "50üí∞"}</button></div><div class="shop-item" style="height:70px"><div style="font-size:25px">üåü</div><div style="font-size:11px; text-align:left; max-width:180px"><b>BEREKET:</b> Oyun ba≈üƒ±nda Altƒ±n Yaƒümuru!</div><button onclick="${bAction}" class="btn" style="min-width:80px; ${bStyle}">${bText}</button></div><div class="shop-item" style="height:70px"><div style="font-size:25px">üöÄ</div><div style="font-size:11px; text-align:left; max-width:180px"><b>ROKET:</b> 30s Otopilot!</div><button onclick="buyRocket()" class="btn" style="min-width:80px; background:#e74c3c">${hasRocket ? "HAZIR" : "500üí∞"}</button></div><div class="shop-item" style="height:70px"><div style="font-size:25px">üíµ</div><div style="font-size:11px; text-align:left; max-width:180px"><b>D√ñVƒ∞Z:</b> 10'lu skorlarda 2x Para!</div><button onclick="buyX2()" class="btn" style="min-width:80px; background:#f1c40f; color:#2c3e50;">${hasX2Counter ? "AKTƒ∞F" : "100üí∞"}</button></div><div class="shop-item" style="height:70px"><div style="font-size:25px">üë®‚Äçüíª</div><div style="font-size:11px; text-align:left; max-width:180px"><b>Hƒ∞LEBAZ:</b> 20 Skor √ñl√ºms√ºz!</div><button onclick="buyCheat()" class="btn" style="min-width:80px; background:#2ecc71; color:white;">${hasCheatMode ? "AKTƒ∞F" : "150üí∞"}</button></div>`;
    } else if (currentTab === "accs") {
        const accs = [{ id: "none", n: "Yok", p: 0 }, { id: "bjk", n: "BJK Formasƒ±", p: 5000 }, { id: "gs", n: "GS Formasƒ±", p: 5000 }, { id: "fb", n: "FB Formasƒ±", p: 5000 }, { id: "adidas", n: "Adidas Takƒ±m", p: 999999 }];
        accs.forEach(item => {
            let isOwned = ownedAccs.includes(item.id);
            let btnText = isOwned ? (currentAcc === item.id ? "Gƒ∞Yƒ∞LDƒ∞" : "Gƒ∞Y") : (item.id === "adidas" ? "KOD GEREKLƒ∞" : `üí∞ ${item.p}`);
            content.innerHTML += `<div class="shop-item"><span>${item.n}</span><button onclick="buyAcc('${item.id}', ${item.p})" class="btn" style="min-width:80px; font-size:14px;">${btnText}</button></div>`;
        });
    }
}

function buyColor(c, p) { if (ownedColors.includes(c)) birdColor = c; else if (totalGold >= p) { totalGold -= p; ownedColors.push(c); birdColor = c; playSound('coin'); } saveData(); renderShop(); updateUI(); }
function buyTrail(c, p) { if (ownedTrails.includes(c)) currentTrail = c; else if (totalGold >= p) { totalGold -= p; ownedTrails.push(c); currentTrail = c; playSound('coin'); } saveData(); renderShop(); updateUI(); }
function buyRocket() { if (!hasRocket && totalGold >= 500) { totalGold -= 500; hasRocket = true; saveData(); renderShop(); updateUI(); playSound('coin'); } }
function buyX2() { if (!hasX2Counter && totalGold >= 100) { totalGold -= 100; hasX2Counter = true; saveData(); renderShop(); updateUI(); playSound('coin'); } } 
function buyCheat() { if (!hasCheatMode && totalGold >= 150) { totalGold -= 150; hasCheatMode = true; saveData(); renderShop(); updateUI(); playSound('coin'); } }
function buyBereket() { let now = Date.now(); let cooldown = 5 * 60 * 1000; if (!hasBereket && (now - lastBereketTime >= cooldown)) { if (totalGold >= 150) { totalGold -= 150; hasBereket = true; lastBereketTime = now; localStorage.setItem("lastBereketTime", lastBereketTime); saveData(); renderShop(); updateUI(); playSound('coin'); } } }
function buyShrink() { if (!hasShrink && totalGold >= 50) { totalGold -= 50; hasShrink = true; saveData(); renderShop(); updateUI(); playSound('coin'); } }
function buyAcc(id, p) { if (ownedAccs.includes(id)) currentAcc = id; else if (id !== "adidas" && totalGold >= p) { totalGold -= p; ownedAccs.push(id); currentAcc = id; playSound('coin'); } saveData(); renderShop(); updateUI(); }

function saveData() { 
    localStorage.setItem("totalGold", totalGold); localStorage.setItem("ownedColors", JSON.stringify(ownedColors)); localStorage.setItem("birdColor", birdColor);
    localStorage.setItem("currentTrail", currentTrail); localStorage.setItem("ownedTrails", JSON.stringify(ownedTrails));
    localStorage.setItem("currentAcc", currentAcc); localStorage.setItem("ownedAccs", JSON.stringify(ownedAccs)); localStorage.setItem("musicEnabled", musicEnabled);
    localStorage.setItem("setupComplete", "true"); localStorage.setItem("isAdmin", isAdmin);
}

function checkInit() { if (!playerNick) { nickMenu.style.display = "flex"; menu.style.display = "none"; } else if (!setupComplete) { langMenu.style.display = "flex"; menu.style.display = "none"; } }
function finishSetup() { langMenu.style.display = "none"; menu.style.display = "flex"; setupComplete = true; saveData(); }

document.getElementById("nickSaveBtn").onclick = () => {
    const val = nickInput.value.trim();
    if (val.length >= 2) { playerNick = val; localStorage.setItem("playerNick", playerNick); nickMenu.style.display = "none"; langMenu.style.display = "flex"; } else alert("L√ºtfen en az 2 karakterli bir nick girin!");
};

document.getElementById("creditsOpenBtn").onclick = () => {
    creditsOverlay.style.display = "flex"; creditsContent.style.transition = "none"; creditsContent.style.transform = "translateY(0)";
    setTimeout(() => {
        creditsContent.style.transition = "transform 35s linear";
        const distance = window.innerHeight + creditsContent.offsetHeight;
        creditsContent.style.transform = `translateY(-${distance + 500}px)`;
    }, 100);
};

document.getElementById("creditsCloseBtn").onclick = () => { creditsOverlay.style.display = "none"; creditsContent.style.transition = "none"; creditsContent.style.transform = "translateY(0)"; };
document.getElementById("resetAccountBtn").onclick = () => { if (confirm("T√ºm altƒ±nlarƒ±n ve skorlarƒ±n silinecek. Emin misin?")) { localStorage.clear(); location.reload(); } };

document.getElementById("playBtn").onclick = handlePlayClick;
document.getElementById("retryBtn").onclick = prepareGame;
document.getElementById("lobbyBtn").onclick = () => { state = "menu"; deathScreen.style.display = "none"; mainButtons.style.display = "block"; updateUI(); };

document.getElementById("shopOpenBtn").onclick = () => { shopMenu.style.display = "flex"; renderShop(); shopInterval = setInterval(renderShop, 1000); };
document.getElementById("shopCloseBtn").onclick = () => { shopMenu.style.display = "none"; clearInterval(shopInterval); };

document.getElementById("setOpenBtn").onclick = () => { settingsMenu.style.display = "flex"; updateMusic(); };
document.getElementById("setCloseBtn").onclick = () => settingsMenu.style.display = "none";
document.getElementById("tabColors").onclick = function() { currentTab = "colors"; switchTab(this); };
document.getElementById("tabTrails").onclick = function() { currentTab = "trails"; switchTab(this); };
document.getElementById("tabItems").onclick = function() { currentTab = "items"; switchTab(this); };
document.getElementById("tabAccs").onclick = function() { currentTab = "accs"; switchTab(this); };
function switchTab(el) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active')); el.classList.add('tab-active'); renderShop(); }

document.getElementById("gravSlider").oninput = function() { gravity = parseFloat(this.value); document.getElementById("gravVal").innerText = this.value; };
document.getElementById("jumpSlider").oninput = function() { jumpPower = -parseFloat(this.value); document.getElementById("jumpVal").innerText = parseFloat(this.value).toFixed(1); };
document.getElementById("speedSlider").oninput = function() { baseSpeed = parseFloat(this.value); speed = baseSpeed; document.getElementById("speedVal").innerText = this.value; };
document.getElementById("musicToggleBtn").onclick = function() { musicEnabled = !musicEnabled; updateMusic(); saveData(); };

document.getElementById("redeemOpenBtn").onclick = () => { redeemMenu.style.display = "flex"; };
document.getElementById("redeemCloseBtn").onclick = () => { redeemMenu.style.display = "none"; };
document.getElementById("redeemCheckBtn").onclick = () => {
    const code = document.getElementById("redeemInput").value.trim().toUpperCase();
    let usedCodes = JSON.parse(localStorage.getItem("usedCodesList")) || [];
    if (usedCodes.includes(code)) alert("Bu kod bu hesapta zaten kullanƒ±lmƒ±≈ü!");
    else if (code === "ANTƒ∞√áOKKRALADAM") applyRedeem(code, 0, usedCodes, "ADMIN");
    else if (code === "KODUMUNKEKOSU") applyRedeem(code, 0, usedCodes, "ITEM");
    else alert("Ge√ßersiz kod!");
    document.getElementById("redeemInput").value = "";
};

function applyRedeem(code, amount, usedCodesList, type) {
    usedCodesList.push(code); localStorage.setItem("usedCodesList", JSON.stringify(usedCodesList));
    const msg = document.getElementById("redeemMsg");
    if(type === "ADMIN") { 
        isAdmin = true; 
        msg.innerHTML = `üëë ADMƒ∞N YETKƒ∞Sƒ∞ VERƒ∞LDƒ∞! üëë<br><span style="font-size: 35px;">LOBƒ∞DE PARA BASABƒ∞Lƒ∞RSƒ∞N!</span>`; 
        adminBtn.style.display = "block";
    } 
    else if(type === "ITEM" && code === "KODUMUNKEKOSU") { if(!ownedAccs.includes("adidas")) ownedAccs.push("adidas"); msg.innerHTML = `üî• KEKO SETƒ∞ A√áILDI! üî•`; } 
    else { totalGold += amount; msg.innerHTML = `üéâ TEBRƒ∞KLER! üéâ<br><span style="font-size: 45px;">+${amount.toLocaleString()} üí∞</span>`; }
    saveData(); updateUI(); redeemMenu.style.display = "none"; playSound('coin'); spawnConfetti(); msg.style.display = "block"; setTimeout(() => { msg.style.display = "none"; }, 4000);
}

// ADMƒ∞N PARA BASMA BUTONU
adminBtn.onclick = () => {
    totalGold += 1000;
    playSound('coin');
    updateUI();
    saveData();
};

const handleInput = () => { if(state === "ready") startActualGame(); else if(state === "play" && !rocketActive) { bird.vy = jumpPower; playSound('jump'); } };
window.onkeydown = (e) => { if(e.code === "Space") handleInput(); };
canvas.onmousedown = handleInput;
canvas.ontouchstart = (e) => { e.preventDefault(); handleInput(); };

document.getElementById("breakContinueBtn").onclick = () => { breakOverlay.style.display = "none"; state = "ready"; getReadyUI.style.display = "block"; safeMode = true; safeTimer = 120; };

checkInit(); updateUI(); updateMusic(); loop();
</script>
</body>
</html>
